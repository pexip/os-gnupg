#! /bin/sh /usr/share/dpatch/dpatch-run
## CVE-2013-4242.dpatch by Seth Arnold <seth.arnold@canonical.com>
##
## All lines beginning with `## DP:' are a description of the patch.
# From: Werner Koch <wk@gnupg.org>
# Date: Fri, 19 Jul 2013 11:49:23 +0000 (+0200)
# Subject: Mitigate a flush+reload cache attack on RSA secret exponents.
# X-Git-Tag: gnupg-1.4.14~5
# X-Git-Url: http://git.gnupg.org/cgi-bin/gitweb.cgi?p=gnupg.git;a=commitdiff_plain;h=35646689f4b80955ff7dbe1687bf2c479c53421e;hp=fd86f3031161f11c3cbef643a213a04c821364dd
# 
# Mitigate a flush+reload cache attack on RSA secret exponents.
# 
# * mpi/mpi-pow.c (mpi_powm): Always perform the mpi_mul for exponents
# hold in secure memory.
# --
# 
# The attack is described in a paper to be pusblished at eprint.iacr.org:
# 
# Flush+Reload: a High Resolution, Low Noise, L3 Cache Side-Channel
# Attack by Yuval Yarom and Katrina Falkner. 18 July 2013.
# 
#   Flush+Reload is a cache side-channel attack that monitors access to
#   data in shared pages. In this paper we demonstrate how to use the
#   attack to extract private encryption keys from GnuPG.  The high
#   resolution and low noise of the Flush+Reload attack enables a spy
#   program to recover over 98% of the bits of the private key in a
#   single decryption or signing round. Unlike previous attacks, the
#   attack targets the last level L3 cache. Consequently, the spy
#   program and the victim do not need to share the execution core of
#   the CPU. The attack is not limited to a traditional OS and can be
#   used in a virtualised environment, where it can attack programs
#   executing in a different VM.
# 
# Signed-off-by: Werner Koch <wk@gnupg.org>


@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/NEWS gnupg-1.4.11/NEWS
--- gnupg-1.4.11~/NEWS	2010-10-18 01:49:28.000000000 -0700
+++ gnupg-1.4.11/NEWS	2013-07-30 15:52:47.000000000 -0700
@@ -5,6 +5,15 @@
     
     * Minor changes for better interoperability with GnuPG-2.
 
+    * Mitigate the Yarom/Falkner flush+reload side-channel attack on
+      RSA secret keys.
+
+    * Fixed IDEA for big-endian CPUs
+
+    * Improved the diagnostics for failed keyserver lockups.
+
+    * Minor bug and portability fixes.
+
 
 Noteworthy changes in version 1.4.10 (2009-09-02)
 -------------------------------------------------
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/NEWS.orig gnupg-1.4.11/NEWS.orig
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/mpi/mpi-pow.c gnupg-1.4.11/mpi/mpi-pow.c
--- gnupg-1.4.11~/mpi/mpi-pow.c	2008-12-11 08:39:43.000000000 -0800
+++ gnupg-1.4.11/mpi/mpi-pow.c	2013-07-30 15:52:47.000000000 -0700
@@ -1,5 +1,6 @@
 /* mpi-pow.c  -  MPI functions
- *	Copyright (C) 1994, 1996, 1998, 2000 Free Software Foundation, Inc.
+ * Copyright (C) 1994, 1996, 1998, 2000 Free Software Foundation, Inc.
+ * Copyright (C) 2013 Werner Koch
  *
  * This file is part of GnuPG.
  *
@@ -210,7 +211,14 @@
 		tp = rp; rp = xp; xp = tp;
 		rsize = xsize;
 
-		if( (mpi_limb_signed_t)e < 0 ) {
+                /* To mitigate the Yarom/Falkner flush+reload cache
+                 * side-channel attack on the RSA secret exponent, we
+                 * do the multiplication regardless of the value of
+                 * the high-bit of E.  But to avoid this performance
+                 * penalty we do it only if the exponent has been
+                 * stored in secure memory and we can thus assume it
+                 * is a secret exponent.  */
+                if (esec || (mpi_limb_signed_t)e < 0) {
 		    /*mpihelp_mul( xp, rp, rsize, bp, bsize );*/
 		    if( bsize < KARATSUBA_THRESHOLD ) {
 			mpihelp_mul( xp, rp, rsize, bp, bsize );
@@ -225,7 +233,8 @@
 			mpihelp_divrem(xp + msize, 0, xp, xsize, mp, msize);
 			xsize = msize;
 		    }
-
+                }
+		if ((mpi_limb_signed_t)e < 0) {
 		    tp = rp; rp = xp; xp = tp;
 		    rsize = xsize;
 		}
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/mpi/mpi-pow.c.orig gnupg-1.4.11/mpi/mpi-pow.c.orig
