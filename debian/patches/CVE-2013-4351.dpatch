#! /bin/sh /usr/share/dpatch/dpatch-run
# Description: fix incorrect no-usage-permitted flag handling
# Origin: backported from GnuPG 1.4.15
# Bug-Debian: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=722722

@DPATCH@
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/g10/getkey.c gnupg-1.4.11/g10/getkey.c
--- gnupg-1.4.11~/g10/getkey.c	2009-05-06 04:01:47.000000000 -0400
+++ gnupg-1.4.11/g10/getkey.c	2013-10-08 07:49:41.520606451 -0400
@@ -1452,13 +1452,19 @@
 
       if(flags)
 	key_usage |= PUBKEY_USAGE_UNKNOWN;
+
+      if (!key_usage)
+	key_usage |= PUBKEY_USAGE_NONE;
     }
+  else if (p) /* Key flags of length zero.  */
+    key_usage |= PUBKEY_USAGE_NONE;
 
   /* We set PUBKEY_USAGE_UNKNOWN to indicate that this key has a
      capability that we do not handle.  This serves to distinguish
      between a zero key usage which we handle as the default
      capabilities for that algorithm, and a usage that we do not
-     handle. */
+     handle.  Likewise we use PUBKEY_USAGE_NONE to indicate that
+     key_flags have been given but they do not specify any usage.  */
 
   return key_usage;
 }
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/g10/keygen.c gnupg-1.4.11/g10/keygen.c
--- gnupg-1.4.11~/g10/keygen.c	2010-02-17 03:58:43.000000000 -0500
+++ gnupg-1.4.11/g10/keygen.c	2013-10-08 07:49:41.520606451 -0400
@@ -210,9 +210,6 @@
     if (use & PUBKEY_USAGE_AUTH)
         buf[0] |= 0x20;
 
-    if (!buf[0]) 
-        return;
-
     build_sig_subpkt (sig, SIGSUBPKT_KEY_FLAGS, buf, 1);
 }
 
diff -urNad '--exclude=CVS' '--exclude=.svn' '--exclude=.git' '--exclude=.arch' '--exclude=.hg' '--exclude=_darcs' '--exclude=.bzr' gnupg-1.4.11~/include/cipher.h gnupg-1.4.11/include/cipher.h
--- gnupg-1.4.11~/include/cipher.h	2008-12-11 11:39:58.000000000 -0500
+++ gnupg-1.4.11/include/cipher.h	2013-10-08 07:49:41.520606451 -0400
@@ -54,6 +54,7 @@
 #define PUBKEY_USAGE_CERT    4      /* key is also good to certify other keys*/
 #define PUBKEY_USAGE_AUTH    8      /* key is good for authentication */
 #define PUBKEY_USAGE_UNKNOWN 128    /* key has an unknown usage bit */
+#define PUBKEY_USAGE_NONE    256    /* No usage given. */
 
 #define DIGEST_ALGO_MD5       1
 #define DIGEST_ALGO_SHA1      2
